#!/bin/bash

. ./.env
. ~/bin/.funcs

APP_VERSION=$(app_version)
APP_NAME=$(app_name)
PRODUCTION=$(production_image ${SHORT_NAME})
DIGEST_IMAGE=$(docker inspect --format='{{index .RepoDigests 0}}' ${PRODUCTION})

export PRODUCTION DIGEST_IMAGE

[ -z "${DIGEST_IMAGE}" ] && echo "exit due digest image not set, try push image => \"${PRODUCTION}\" to registry, exit" && exit 1
[ -z "${1}" ] && echo "yaml file as parameter required to apply, not found, exit " && exit 1

echo "application \"${APP_NAME}@v${APP_VERSION}\" apply \"${1}\" to namespace => \"${NAMESPACE}\""
cat ${1} | envsubst | kubectl apply -f -
